<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藥劑科 - 藥品異動通知 | Drug Changes Notification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
            background-color: #f8f9fa; 
        }

        /* 讀取動畫 */
        .loader-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 60vh;
            color: #6c757d;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* 卡片風格 */
        .card { 
            border: none; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.08); 
            margin-bottom: 24px; 
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        
        /* 異動卡片專用樣式 */
        .change-card { border: 1px solid #dee2e6; }
        .change-card.border-danger { border-color: #ffcccc !important; }
        
        .card-header { font-weight: bold; }
        .bg-danger { background-color: #dc3545 !important; }
        
        /* 圖片容器與標籤 */
        .img-wrapper {
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #dee2e6;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .img-wrapper.new-item {
            border: 2px solid #198754;
            background-color: #f8fff9;
        }
        .img-wrapper img {
            max-height: 160px;
            object-fit: contain;
            width: 100%;
        }
        
        .status-badge {
            position: absolute;
            top: -10px;
            left: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 文字樣式 */
        .text-old { text-decoration: line-through; color: #999; font-size: 0.9rem; margin-top: 8px; }
        .text-new { color: #198754; font-weight: bold; font-size: 0.95rem; margin-top: 8px; }

        /* RWD */
        .arrow-col { display: flex; align-items: center; justify-content: center; }
        @media (max-width: 768px) {
            .arrow-col i { transform: rotate(90deg); margin: 15px 0; }
        }

        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <nav class="navbar navbar-dark bg-dark shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fa-solid fa-right-left me-3"></i>
                <div class="d-flex flex-col flex-md-row align-items-baseline">
                    <span class="fs-4 fw-bold me-2">藥品異動通知</span>
                    <span class="fs-6 text-white-50">Pharmacy Intranet</span>
                </div>
            </a>
            <div class="d-flex">
                <input v-model="searchKeyword" class="form-control form-control-sm me-2" type="search" placeholder="搜尋藥名..." aria-label="Search">
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
            <h2 class="h4 text-secondary mb-0"><i class="fa-solid fa-bullhorn me-2"></i>最新公告列表</h2>
            <span class="badge bg-secondary">{{ filteredNotices.length }} 筆資料</span>
        </div>

        <div v-if="error" class="alert alert-danger shadow-sm" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> {{ error }}
        </div>

        <div v-if="loading" class="loader-container">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 fs-5">正在同步雲端資料庫...</p>
        </div>

        <div v-if="!loading && filteredNotices.length === 0" class="text-center py-5 text-muted">
            <i class="fa-regular fa-folder-open fa-4x mb-3"></i>
            <h4>目前無符合條件的異動公告</h4>
            <p>請嘗試其他關鍵字或稍後再試</p>
        </div>

        <div v-if="!loading" class="animate-fade-in">
            <div 
                v-for="(item, index) in filteredNotices" 
                :key="index" 
                class="card change-card border-danger mb-4"
            >
                <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i>異動通知
                    </span>
                    <span class="badge bg-white text-danger">
                        <i class="fa-regular fa-calendar-check me-1"></i> {{ item.date }} 生效
                    </span>
                </div>

                <div class="card-body">
                    <h4 class="card-title fw-bold text-dark mb-1">{{ item.nameAfter }}</h4> 
                    <p class="text-secondary fst-italic mb-3">{{ item.content }} ({{ item.indication }})</p>

                    <div class="row align-items-stretch mt-3 g-3">
                        
                        <div class="col-md-5">
                            <div class="img-wrapper bg-light">
                                <span class="status-badge bg-secondary text-white">OLD</span>
                                <img 
                                    v-if="item.imgBefore" 
                                    :src="item.imgBefore" 
                                    class="img-fluid rounded" 
                                    @error="imageLoadError"
                                    alt="舊外觀"
                                >
                                <div v-else class="text-muted py-4"><i class="fa-solid fa-image-slash fa-2x mb-2"></i><br>無圖片</div>
                                
                                <div class="text-old text-center">
                                    <div class="fw-bold">{{ item.nameBefore }}</div>
                                    <small v-if="item.appearanceBefore">{{ item.appearanceBefore }}</small>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-2 arrow-col">
                            <i class="fa-solid fa-arrow-right fa-2x text-muted opacity-50"></i>
                        </div>

                        <div class="col-md-5">
                            <div class="img-wrapper new-item">
                                <span class="status-badge bg-success text-white">NEW</span>
                                <img 
                                    v-if="item.imgAfter" 
                                    :src="item.imgAfter" 
                                    class="img-fluid rounded" 
                                    @error="imageLoadError"
                                    alt="新外觀"
                                >
                                <div v-else class="text-muted py-4"><i class="fa-solid fa-image-slash fa-2x mb-2"></i><br>無圖片</div>
                                
                                <div class="text-new text-center">
                                    <div class="fw-bold">{{ item.nameAfter }}</div>
                                    <small v-if="item.appearanceAfter">{{ item.appearanceAfter }}</small>
                                </div>
                            </div>
                        </div>

                    </div> 
                    
                    <div class="alert alert-warning mt-4 mb-0 d-flex align-items-center small" role="alert">
                        <i class="fa-solid fa-circle-info me-2 fa-lg"></i>
                        <div>
                            <strong>藥師提醒：</strong> 
                            請注意藥品外觀改變，核對藥名與劑量是否正確。
                            <span v-if="item.nameBefore !== item.nameAfter">商品名已變更。</span>
                        </div>
                    </div>

                </div> 
            </div>
        </div>

    </div>

    <footer class="bg-dark text-white-50 text-center py-3 mt-5">
        <small>&copy; 衛生福利部豐原醫院 藥劑科 | 資料來源：Google Sheets Cloud Database</small>
    </footer>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    const DRUG_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const NOTICE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvkgeCPqEuhBiCXEEBLGyGZ_6KVPiaodmK0HEd7bEVN2EFGeyF8z32H7U15oheywWzqZOyuy_qdchX/pub?output=csv';
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 

    createApp({
        setup() {
            const notices = ref([]);
            const loading = ref(true);
            const error = ref('');
            const searchKeyword = ref('');

            const fetchCsv = (url) => new Promise((resolve, reject) => {
                Papa.parse(url, { 
                    download: true, 
                    header: true, 
                    skipEmptyLines: true, 
                    complete: (r) => resolve(r.data), 
                    error: (e) => reject(e) 
                });
            });

            const parseRowToDrug = (row) => {
                // 這裡的邏輯必須非常寬鬆，因為我們需要建立一個包含「所有歷史藥品」的索引
                // 即使該藥品已停用或不符合顯示規範，為了顯示歷史公告，我們仍需要它的資料
                const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                if(!code) return null;
                const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                
                return {
                    code,
                    genericName: row['學名'] || '',
                    tradeName: row['商品名(英文)'] || row['商品名'] || '無商品名',
                    indication: row['適應症']||row['臨床用途']||'尚無資料',
                    imgUrl: imgName ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}` : null,
                    appearance: row['藥品外觀'] ? row['藥品外觀'].trim() : ''
                };
            };

            const fetchAllData = () => {
                loading.value = true;
                Promise.all([fetchCsv(DRUG_DATA_URL), fetchCsv(NOTICE_DATA_URL)])
                    .then(([drugData, noticeData]) => {
                        
                        // 【關鍵修正】建立完整藥檔 Map 時，不要進行任何過濾！
                        // 原始網站邏輯：只要有代碼的藥品，全部納入索引。
                        // 這樣才能確保「異動公告」能找到那些已經被標記為停用或非本院的舊藥品資料。
                        const allDrugsMap = {};
                        drugData.forEach(row => {
                            const drug = parseRowToDrug(row);
                            if (drug) allDrugsMap[drug.code] = drug;
                        });

                        processNoticeData(noticeData, allDrugsMap);
                        loading.value = false;
                    })
                    .catch(err => {
                        console.error(err);
                        error.value = "資料讀取失敗，請檢查網路連線。";
                        loading.value = false;
                    });
            };

            const processNoticeData = (data, allDrugsMap) => {
                if (!data || data.length === 0) return;

                // 這裡維持原網站邏輯：只抓半年前的資料，或者你可以依需求調整為一年
                const now = new Date();
                const pastLimit = new Date();
                pastLimit.setMonth(now.getMonth() - 12); // 設定為顯示過去 12 個月內的異動

                let processed = data.map(row => {
                    const dateStr = row['異動日期'] ? row['異動日期'].trim() : '';
                    if (!dateStr) return null;

                    // 這裡維持原網站的日期解析邏輯
                    const dateParts = dateStr.split('/');
                    if (dateParts.length < 3) return null;
                    const noticeDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));

                    if (noticeDate < pastLimit) return null;

                    const beforeCode = row['異動前'] ? row['異動前'].trim() : '';
                    const afterCode = row['異動後'] ? row['異動後'].trim() : '';

                    const beforeDrug = allDrugsMap[beforeCode] || null;
                    const afterDrug = allDrugsMap[afterCode] || null;

                    // 這裡維持原網站的判斷邏輯：兩者都找不到才不顯示
                    if (!beforeDrug && !afterDrug) return null;

                    const displayDrug = afterDrug || beforeDrug;

                    return {
                        date: dateStr,
                        sortingKey: parseDateToNumber(dateStr),
                        
                        nameBefore: beforeDrug ? beforeDrug.tradeName : '查無資料',
                        nameAfter: afterDrug ? afterDrug.tradeName : '查無資料',
                        imgBefore: beforeDrug ? beforeDrug.imgUrl : null,
                        imgAfter: afterDrug ? afterDrug.imgUrl : null,
                        appearanceBefore: beforeDrug ? beforeDrug.appearance : '',
                        appearanceAfter: afterDrug ? afterDrug.appearance : '',
                        
                        content: displayDrug.genericName,
                        indication: displayDrug.indication
                    };
                }).filter(d => d !== null);

                processed.sort((a, b) => b.sortingKey - a.sortingKey);
                notices.value = processed;
            };

            const parseDateToNumber = (dateStr) => {
                const parts = dateStr.split('/'); 
                if (parts.length < 3) return 0;
                return parseInt(parts[0] + parts[1].padStart(2, '0') + parts[2].padStart(2, '0'));
            };

            const imageLoadError = (e) => { 
                e.target.style.display = 'none';
                e.target.parentElement.innerHTML = '<div class="text-muted py-4"><i class="fa-solid fa-image-slash fa-2x mb-2"></i><br>圖片失效</div>';
            }; 

            const filteredNotices = computed(() => {
                if (!searchKeyword.value) return notices.value;
                const k = searchKeyword.value.toLowerCase();
                return notices.value.filter(n => 
                    n.nameAfter.toLowerCase().includes(k) || 
                    n.nameBefore.toLowerCase().includes(k) ||
                    n.content.toLowerCase().includes(k)
                );
            });

            onMounted(() => { fetchAllData(); });

            return {
                notices, filteredNotices, loading, error, imageLoadError, searchKeyword
            };
        }
    }).mount('#app');
</script>

</body>
</html>
