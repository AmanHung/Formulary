<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>民眾藥品查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        /* 加深陰影讓卡片更立體 */
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #10b981; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" v-cloak class="w-full max-w-7xl mx-auto bg-white min-h-screen relative flex flex-col shadow-2xl">

    <div v-if="error" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-xl shadow-lg">
        <p class="font-bold text-lg"><i class="fa-solid fa-triangle-exclamation mr-2"></i> 系統訊息</p>
        <p class="text-base">{{ error }}</p>
        <button @click="error = ''" class="mt-3 text-sm bg-white border border-red-300 px-4 py-2 rounded-lg">關閉</button>
    </div>

    <header class="sticky top-0 bg-emerald-600 p-5 shadow-lg z-30">
        <div class="flex justify-between items-center mb-5">
            <h1 class="text-white text-2xl md:text-3xl font-bold flex items-center cursor-pointer tracking-wide" @click="resetToHome">
                <i class="fa-solid fa-pills mr-3"></i> 民眾藥品查詢
            </h1>
            <button v-if="keyword" @click="resetToHome" class="text-base bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2 rounded-full transition border border-emerald-400 shadow-md">
                <i class="fa-solid fa-rotate-left mr-1"></i> 重新搜尋
            </button>
        </div>

        <div class="relative max-w-4xl mx-auto">
            <i class="fa-solid fa-magnifying-glass absolute left-6 top-5 text-gray-400 text-2xl"></i>
            <input 
                v-model="keyword" 
                type="text" 
                placeholder="請輸入藥名、適應症 (例如：頭痛、胃痛)..." 
                class="w-full pl-16 pr-12 py-4 rounded-full border-none focus:ring-4 focus:ring-emerald-300 outline-none shadow-xl text-gray-800 text-xl placeholder:text-gray-400"
            >
            <button v-if="keyword" @click="keyword=''" class="absolute right-5 top-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-circle-xmark text-3xl"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 p-4 md:p-6 bg-gray-50 overflow-y-auto">
        
        <div v-if="loading" class="text-center py-32 text-gray-500">
            <div class="loader"></div>
            <p class="text-xl mt-4">資料載入中，請稍候...</p>
        </div>

        <div v-if="!loading && !keyword" class="flex flex-col items-center justify-center py-32 text-gray-400">
            <div class="bg-gray-100 p-10 rounded-full mb-6">
                <i class="fa-solid fa-capsules text-7xl text-emerald-200"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-600 mb-3">歡迎使用藥品查詢</h2>
            <p class="text-xl text-gray-500">請在上方輸入關鍵字查詢本院藥品資訊</p>
        </div>

        <div v-if="!loading && keyword" class="animate-slide-up">
            <div v-if="filteredDrugs.length === 0" class="text-center py-32 text-gray-400">
                <i class="fa-regular fa-folder-open text-6xl mb-4 text-gray-300"></i>
                <p class="text-2xl">找不到符合「{{ keyword }}」的藥品</p>
            </div>

            <div v-else>
                <p class="mb-4 text-gray-600 font-bold px-1 text-lg">搜尋結果：共 {{ filteredDrugs.length }} 筆</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <div 
                        v-for="drug in filteredDrugs" 
                        :key="drug.code" 
                        @click="openDetail(drug)"
                        class="bg-white rounded-2xl p-5 card-shadow border border-gray-100 hover:border-emerald-400 hover:shadow-lg active:bg-emerald-50 transition-all cursor-pointer flex flex-col h-full"
                    >
                        <div class="flex items-start mb-4">
                            <div class="w-24 h-24 bg-gray-100 rounded-xl flex-shrink-0 mr-5 overflow-hidden border flex items-center justify-center">
                                <img v-if="drug.imgUrl" :src="drug.imgUrl" class="w-full h-full object-cover" loading="lazy" @error="imageLoadError">
                                <i v-else class="fa-solid fa-image text-gray-300 text-4xl"></i>
                            </div>
                            <div class="flex-1 min-w-0 py-1">
                                <h3 class="font-bold text-xl md:text-2xl leading-tight mb-2 text-emerald-800 break-words">
                                    {{ drug.tradeName }}
                                </h3>
                                <p class="text-gray-500 text-base font-medium">{{ drug.genericName }}</p>
                            </div>
                        </div>
                        
                        <div class="mt-auto bg-gray-50 p-3 rounded-xl">
                            <span class="text-sm font-bold text-gray-400 block mb-1">適應症 (用途)</span>
                            <p class="text-gray-700 text-base md:text-lg line-clamp-2">{{ drug.indication }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selectedDrug" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-md p-4" @click.self="closeDetail">
        <div class="bg-white w-full max-w-2xl rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up max-h-[90vh]">
            
            <div class="flex justify-between items-start p-5 border-b bg-gray-50">
                <div class="flex-1 pr-4">
                    <h2 class="font-bold text-2xl md:text-3xl text-gray-800 leading-tight">{{ selectedDrug.tradeName }}</h2>
                    <p class="text-gray-500 text-lg mt-1">{{ selectedDrug.genericName }}</p>
                </div>
                <button @click="closeDetail" class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition flex-shrink-0">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <div class="w-full bg-white rounded-2xl border flex items-center justify-center overflow-hidden relative shadow-sm min-h-[250px]">
                    <img v-if="selectedDrug.imgUrl" :src="selectedDrug.imgUrl" class="max-h-72 object-contain" @error="imageLoadError">
                    <div v-else class="text-gray-400 py-16 flex flex-col items-center">
                        <i class="fa-solid fa-image text-6xl mb-3"></i>
                        <span class="text-lg">暫無圖片</span>
                    </div>
                </div>

                <section>
                    <h3 class="text-xl font-bold text-emerald-600 mb-3 border-b-2 border-emerald-100 pb-2 flex items-center">
                        <i class="fa-solid fa-stethoscope mr-3"></i> 適應症 (用途)
                    </h3>
                    <p class="text-gray-800 text-lg md:text-xl leading-relaxed">{{ selectedDrug.indication }}</p>
                </section>

                <section v-if="selectedDrug.sideEffect">
                    <h3 class="text-xl font-bold text-orange-600 mb-3 border-b-2 border-orange-100 pb-2 flex items-center">
                        <i class="fa-solid fa-notes-medical mr-3"></i> 可能副作用
                    </h3>
                    <p class="text-gray-800 text-lg md:text-xl leading-relaxed">{{ selectedDrug.sideEffect }}</p>
                </section>

                <section v-if="selectedDrug.profNote">
                    <h3 class="text-xl font-bold text-blue-600 mb-3 border-b-2 border-blue-100 pb-2 flex items-center">
                        <i class="fa-solid fa-circle-info mr-3"></i> 用藥須知
                    </h3>
                    <p class="text-gray-800 text-lg md:text-xl leading-relaxed bg-blue-50 p-4 rounded-xl border border-blue-100">
                        {{ selectedDrug.profNote }}
                    </p>
                </section>

            </div>
            
            <div class="p-5 border-t bg-gray-50">
                <button @click="closeDetail" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl text-center font-bold text-xl shadow-md transition tracking-widest">
                    關 閉
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    const DRUG_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const ATC_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMhr-Ocv4uEN6virOvzsEY-c1-tCEs-e1lB-fvB9d2U2XCtcDaHnLnob_Vu6Ktjce4YErY9y6FuaxD/pub?output=csv';
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 

    createApp({
        setup() {
            const keyword = ref('');
            const drugs = ref([]);
            const selectedDrug = ref(null);
            const loading = ref(true);
            const error = ref('');

            let fuse = null;
            const fuseOptions = {
                keys: [
                    { name: 'tradeName', weight: 0.4 },
                    { name: 'genericName', weight: 0.3 },
                    { name: 'indication', weight: 0.3 }
                ],
                threshold: 0.3,       
                ignoreLocation: true,
                useExtendedSearch: true
            };

            const fetchCsv = (url) => new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: (r) => resolve(r.data), error: (e) => reject(e) });
            });

            const fetchAllData = () => {
                loading.value = true;
                Promise.all([fetchCsv(DRUG_DATA_URL), fetchCsv(ATC_DATA_URL)])
                    .then(([drugData, atcData]) => {
                        const atcMap = {};
                        atcData.forEach(row => {
                            if(row['藥品代碼']) {
                                atcMap[row['藥品代碼'].trim()] = {
                                    orderNote: row['醫令提示訊息'] ? row['醫令提示訊息'].trim() : '' 
                                };
                            }
                        });
                        processData(drugData, atcMap);
                        loading.value = false;
                    })
                    .catch(err => {
                        console.error(err);
                        error.value = "資料讀取失敗，請稍後再試。";
                        loading.value = false;
                    });
            };

            const processData = (rawData, atcMap) => {
                let processed = rawData.map(row => {
                    const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                    if(!code) return null;
                    
                    if (code.length !== 6) return null;
                    if (code.startsWith('653')) return null;

                    const genericName = row['學名'] || '';
                    const tradeName = row['商品名(英文)'] || row['商品名'] || '無商品名';

                    if (tradeName.includes('贈') || genericName.includes('贈')) return null;

                    // 1. 判斷是否停用 (民眾版不顯示停用藥品)
                    const status1 = row['門診停用否'] ? row['門診停用否'].trim().toUpperCase() : '';
                    const status2 = row['住院停用否'] ? row['住院停用否'].trim().toUpperCase() : '';
                    let isDiscontinued = (status1 === 'Y' || status2 === 'Y') && !(status1 === 'N' || status2 === 'N');

                    if (isDiscontinued) return null;

                    const mapData = atcMap[code] || { orderNote: '' };
                    const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';

                    return {
                        code, 
                        genericName, tradeName, 
                        indication: row['適應症']||row['臨床用途']||'尚無資料', 
                        sideEffect: row['副作用']||'',
                        profNote: row['醫護用藥須知'] ? row['醫護用藥須知'].trim() : '', 
                        
                        // 已移除 dosage 欄位處理

                        imgUrl: imgName ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}` : null,
                    };
                }).filter(d => d !== null);

                drugs.value = processed;
                fuse = new Fuse(processed, fuseOptions);
            };

            const filteredDrugs = computed(() => {
                if (!keyword.value) return [];
                
                const k = keyword.value.trim();
                if (fuse) {
                    const searchResults = fuse.search(k);
                    return searchResults.map(res => res.item);
                }
                return [];
            });

            const resetToHome = () => { keyword.value = ''; };
            const openDetail = (drug) => selectedDrug.value = drug;
            const closeDetail = () => selectedDrug.value = null;
            const imageLoadError = (e) => { e.target.style.display = 'none'; }; 

            onMounted(() => { fetchAllData(); });

            return {
                keyword, filteredDrugs, selectedDrug, loading, error,
                resetToHome, openDetail, closeDetail, imageLoadError
            };
        }
    }).mount('#app');
</script>
</body>
</html>
