<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>衛生福利部豐原醫院 - 民眾藥品查詢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fy-dark-green': '#008542', 
                        'fy-green': '#CDE69C', 
                        'fy-light-green-bg': '#f0fdf4', 
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #008542; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        [v-cloak] { display: none; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app" v-cloak class="w-full bg-white min-h-screen relative flex flex-col border-t-8 border-fy-dark-green">

    <div v-if="error" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-xl shadow-lg">
        <p class="font-bold text-lg"><i class="fa-solid fa-triangle-exclamation mr-2"></i> 系統訊息</p>
        <p class="text-base">{{ error }}</p>
        <button @click="error = ''" class="mt-3 text-sm bg-white border border-red-300 px-4 py-2 rounded-lg">關閉</button>
    </div>

    <header class="sticky top-0 bg-fy-green p-4 shadow-md z-30">
        <div class="relative flex justify-between items-center mb-4">
            <div class="flex flex-col items-start z-10">
                <div class="cursor-pointer" @click="resetToHome">
                    <img src="logo_left.png" alt="衛生福利部豐原醫院" class="h-10 md:h-14 mr-3">
                </div>
                <a href="https://www.fyh.mohw.gov.tw/" target="_blank" class="text-sm md:text-base font-bold text-fy-dark-green hover:text-black mt-1 ml-1 transition flex items-center no-underline">
                    <i class="fa-solid fa-hospital mr-1"></i> 回醫院首頁
                </a>
            </div>

            <h1 
                class="absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-800 text-3xl md:text-4xl font-bold tracking-wider hidden sm:block cursor-pointer whitespace-nowrap"
                @click="resetToHome"
            >
                民眾藥品查詢
            </h1>

            <button v-if="keyword" @click="resetToHome" class="text-base md:text-lg bg-white text-fy-dark-green hover:bg-gray-100 px-5 py-2 rounded-full transition shadow font-bold flex items-center whitespace-nowrap z-10">
                <i class="fa-solid fa-rotate-left mr-1 md:mr-2"></i> 重新搜尋
            </button>
        </div>

        <div class="relative max-w-4xl mx-auto">
            <input 
                v-model="keyword" 
                type="text" 
                placeholder="請輸入藥名、適應症 (例如：頭痛、胃痛)..." 
                class="w-full pl-6 pr-14 py-3 md:py-4 rounded-full border-2 border-green-200 focus:border-fy-dark-green focus:ring-4 focus:ring-green-200 outline-none shadow-lg text-gray-800 text-xl md:text-2xl placeholder:text-gray-400"
            >
            <button class="absolute right-2 top-2 bottom-2 bg-fy-dark-green hover:bg-green-800 text-white rounded-full w-10 md:w-12 flex items-center justify-center transition" @click="keyword && (keyword='')">
                <i v-if="!keyword" class="fa-solid fa-magnifying-glass text-xl md:text-2xl"></i>
                <i v-else class="fa-solid fa-xmark text-xl md:text-2xl"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 p-4 md:p-8 bg-white overflow-y-auto">
        
        <div v-if="loading" class="text-center py-32 text-gray-500">
            <div class="loader"></div>
            <p class="text-2xl mt-4">資料同步中，請稍候...</p>
        </div>

        <div v-if="!loading && !keyword" class="w-full max-w-[90rem] mx-auto py-8 px-2 md:px-4 animate-slide-up">
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-bold text-fy-dark-green flex items-center justify-center">
                    <i class="fa-solid fa-bullhorn mr-3 animate-pulse"></i> 最新藥品異動公告
                </h2>
                <p class="text-gray-500 mt-2 text-lg">請注意近期本院藥品外觀或品項之變更</p>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div v-for="(notice, index) in notices" :key="index" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden flex flex-col h-full hover:shadow-xl transition duration-300">
                    
                    <div class="bg-green-50 px-4 py-2 border-b border-green-100 flex justify-end items-center">
                        <span class="text-fy-dark-green text-base font-bold flex items-center">
                            <i class="fa-regular fa-calendar-check mr-2"></i> {{ notice.date }} 生效
                        </span>
                    </div>

                    <div class="p-6 flex-1 flex flex-col">
                        <div class="flex flex-col md:flex-row items-stretch justify-center mb-6 gap-4 md:gap-6">
                            
                            <div class="flex-1 w-full flex flex-col relative border border-gray-100 rounded-xl p-3 bg-gray-50">
                                <div class="absolute top-0 left-0 bg-gray-500 text-white text-sm font-bold px-3 py-1 rounded-br-lg rounded-tl-lg shadow-sm z-10">
                                    異動前
                                </div>

                                <h4 class="text-xl font-bold text-gray-600 mt-8 mb-2 text-center leading-tight">
                                    {{ notice.nameBefore }}
                                </h4>

                                <div class="w-full aspect-[4/3] bg-white rounded-lg border border-gray-200 flex items-center justify-center overflow-hidden relative">
                                    <img v-if="notice.imgBefore" :src="notice.imgBefore" class="w-full h-full object-contain p-2" @error="imageLoadError">
                                    <span v-else class="text-gray-400 text-base">無圖片</span>
                                </div>
                            </div>

                            <div class="flex-shrink-0 flex items-center justify-center py-2 md:py-0">
                                <i class="fa-solid fa-arrow-right text-4xl text-gray-300 hidden md:block"></i>
                                <i class="fa-solid fa-arrow-down text-4xl text-gray-300 md:hidden"></i>
                            </div>

                            <div class="flex-1 w-full flex flex-col relative border border-green-100 rounded-xl p-3 bg-white shadow-sm ring-1 ring-green-50">
                                <div class="absolute top-0 left-0 bg-fy-dark-green text-white text-sm font-bold px-3 py-1 rounded-br-lg rounded-tl-lg shadow-sm z-10">
                                    異動後
                                </div>

                                <h4 class="text-xl font-bold text-fy-dark-green mt-8 mb-2 text-center leading-tight">
                                    {{ notice.nameAfter }}
                                </h4>

                                <div class="w-full aspect-[4/3] bg-white rounded-lg border border-green-200 flex items-center justify-center overflow-hidden relative">
                                    <img v-if="notice.imgAfter" :src="notice.imgAfter" class="w-full h-full object-contain p-2" @error="imageLoadError">
                                    <span v-else class="text-gray-400 text-base">無圖片</span>
                                    <div class="absolute top-0 right-0 w-0 h-0 border-t-[36px] border-t-red-500 border-l-[36px] border-l-transparent transform rotate-0"></div>
                                    <span class="absolute top-0 right-1 text-xs text-white font-bold">N</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-fy-light-green-bg rounded-xl p-4 border border-green-100 grid grid-cols-1 md:grid-cols-2 gap-4 mt-auto">
                            <div>
                                <span class="text-sm font-bold text-gray-500 block mb-1">成分含量</span>
                                <p class="text-gray-800 text-lg font-medium">{{ notice.content || '未提供' }}</p>
                            </div>
                            <div>
                                <span class="text-sm font-bold text-gray-500 block mb-1">適應症</span>
                                <p class="text-gray-800 text-lg font-medium">{{ notice.indication || '未提供' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="notices.length === 0" class="text-center py-20 text-gray-400">
                <div class="bg-green-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-check text-5xl text-fy-dark-green"></i>
                </div>
                <p class="text-2xl font-bold text-gray-600">目前無最新的藥品異動公告</p>
                <p class="text-base mt-2 text-gray-400">(僅顯示近六個月內的異動資訊)</p>
            </div>
        </div>

        <div v-if="!loading && keyword" class="animate-slide-up">
            <div v-if="filteredDrugs.length === 0" class="text-center py-32 text-gray-400">
                <i class="fa-regular fa-folder-open text-7xl mb-4 text-gray-300"></i>
                <p class="text-3xl">找不到符合「{{ keyword }}」的藥品</p>
            </div>

            <div v-else>
                <div class="flex items-center mb-6 px-1">
                    <span class="bg-fy-dark-green w-2 h-8 mr-3 rounded"></span>
                    <p class="text-gray-700 font-bold text-2xl">搜尋結果：共 {{ filteredDrugs.length }} 筆</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div 
                        v-for="drug in filteredDrugs" 
                        :key="drug.code" 
                        @click="openDetail(drug)"
                        class="bg-white rounded-2xl p-5 card-shadow border border-gray-200 hover:border-fy-dark-green hover:shadow-xl active:bg-green-50 transition-all cursor-pointer flex flex-col h-full group"
                    >
                        <div class="flex items-start mb-4">
                            <div class="w-28 h-28 bg-gray-50 rounded-xl flex-shrink-0 mr-5 overflow-hidden border border-gray-200 flex items-center justify-center group-hover:border-green-300 transition">
                                <img v-if="drug.imgUrl" :src="drug.imgUrl" class="w-full h-full object-cover" loading="lazy" @error="imageLoadError">
                                <i v-else class="fa-solid fa-image text-gray-300 text-5xl"></i>
                            </div>
                            <div class="flex-1 min-w-0 py-1">
                                <h3 class="font-bold text-2xl md:text-3xl leading-tight mb-2 text-fy-dark-green break-words group-hover:text-green-700">
                                    {{ drug.tradeName }}
                                </h3>
                                <p class="text-gray-500 text-lg font-medium line-clamp-2">{{ drug.genericName }}</p>
                            </div>
                        </div>
                        
                        <div class="mt-auto bg-fy-light-green-bg p-5 rounded-xl border border-green-100">
                            <span class="text-base font-bold text-gray-500 block mb-1">適應症 (用途)</span>
                            <p class="text-gray-800 text-lg md:text-xl line-clamp-2">{{ drug.indication }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selectedDrug" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-md p-4" @click.self="closeDetail">
        <div class="bg-white w-full max-w-3xl rounded-2xl flex flex-col overflow-hidden shadow-2xl animate-slide-up max-h-[90vh] border-t-8 border-fy-dark-green">
            
            <div class="flex justify-between items-start p-6 border-b bg-gray-50">
                <div class="flex-1 pr-4">
                    <h2 class="font-bold text-3xl md:text-4xl text-gray-800 leading-tight">{{ selectedDrug.tradeName }}</h2>
                    <p class="text-gray-500 text-xl mt-2 font-medium">{{ selectedDrug.genericName }}</p>
                </div>
                <button @click="closeDetail" class="w-14 h-14 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-gray-600 transition flex-shrink-0">
                    <i class="fa-solid fa-times text-3xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                
                <div class="w-full bg-white rounded-2xl border flex items-center justify-center overflow-hidden relative shadow-sm min-h-[300px]">
                    <img v-if="selectedDrug.imgUrl" :src="selectedDrug.imgUrl" class="max-h-80 object-contain" @error="imageLoadError">
                    <div v-else class="text-gray-400 py-20 flex flex-col items-center">
                        <i class="fa-solid fa-image text-7xl mb-4"></i>
                        <span class="text-xl">暫無圖片</span>
                    </div>
                </div>

                <div v-if="selectedDrug.appearance" class="bg-fy-light-green-bg rounded-xl p-5 flex items-start border border-green-100 shadow-sm">
                    <div class="flex-shrink-0 mr-4 mt-1">
                        <i class="fa-solid fa-eye text-fy-dark-green text-2xl"></i>
                    </div>
                    <div>
                        <span class="text-base font-bold text-fy-dark-green block mb-1">藥品外觀</span>
                        <p class="text-gray-800 text-lg leading-relaxed">{{ selectedDrug.appearance }}</p>
                    </div>
                </div>

                <section>
                    <h3 class="text-2xl font-bold text-fy-dark-green mb-3 border-b-2 border-green-100 pb-2 flex items-center">
                        <i class="fa-solid fa-stethoscope mr-3"></i> 適應症 (用途)
                    </h3>
                    <p class="text-gray-800 text-xl md:text-2xl leading-relaxed">{{ selectedDrug.indication }}</p>
                </section>

                <section v-if="selectedDrug.sideEffect">
                    <h3 class="text-2xl font-bold text-orange-600 mb-3 border-b-2 border-orange-100 pb-2 flex items-center">
                        <i class="fa-solid fa-notes-medical mr-3"></i> 可能副作用
                    </h3>
                    <p class="text-gray-800 text-xl md:text-2xl leading-relaxed">{{ selectedDrug.sideEffect }}</p>
                </section>

                <section v-if="selectedDrug.profNote">
                    <h3 class="text-2xl font-bold text-fy-dark-green mb-3 border-b-2 border-green-100 pb-2 flex items-center">
                        <i class="fa-solid fa-circle-info mr-3"></i> 用藥須知 (注意事項)
                    </h3>
                    <p class="text-gray-800 text-xl md:text-2xl leading-relaxed bg-green-50 p-5 rounded-xl border border-green-100">
                        {{ selectedDrug.profNote }}
                    </p>
                </section>

            </div>
            
            <div class="p-6 border-t bg-gray-50">
                <button @click="closeDetail" class="w-full bg-fy-dark-green hover:bg-green-800 text-white py-4 rounded-xl text-center font-bold text-2xl shadow-md transition tracking-widest">
                    關 閉
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    const DRUG_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTl_HoBeP0qBD79IB7Ulp_xAMRX4Gyx65pgU-4Kf15Lu4g4FqGdVBDSn1BEI6sNXht889zjRx6RErb-/pub?output=csv';
    const ATC_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMhr-Ocv4uEN6virOvzsEY-c1-tCEs-e1lB-fvB9d2U2XCtcDaHnLnob_Vu6Ktjce4YErY9y6FuaxD/pub?output=csv';
    const NOTICE_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvkgeCPqEuhBiCXEEBLGyGZ_6KVPiaodmK0HEd7bEVN2EFGeyF8z32H7U15oheywWzqZOyuy_qdchX/pub?output=csv';
    
    const CLOUDINARY_CLOUD_NAME = 'de02nbokt'; 

    createApp({
        setup() {
            const keyword = ref('');
            const drugs = ref([]);
            const notices = ref([]); 
            const selectedDrug = ref(null);
            const loading = ref(true);
            const error = ref('');

            let fuse = null;
            const fuseOptions = {
                keys: [
                    { name: 'tradeName', weight: 0.4 },
                    { name: 'genericName', weight: 0.3 },
                    { name: 'indication', weight: 0.3 }
                ],
                threshold: 0.3,       
                ignoreLocation: true,
                useExtendedSearch: true
            };

            const fetchCsv = (url) => new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true, complete: (r) => resolve(r.data), error: (e) => reject(e) });
            });

            const parseRowToDrug = (row, atcMap) => {
                const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                if(!code) return null;
                const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                
                return {
                    code,
                    genericName: row['學名'] || '',
                    tradeName: row['商品名(英文)'] || row['商品名'] || '無商品名',
                    indication: row['適應症']||row['臨床用途']||'尚無資料',
                    imgUrl: imgName ? `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}` : null,
                };
            };

            const fetchAllData = () => {
                loading.value = true;
                Promise.all([fetchCsv(DRUG_DATA_URL), fetchCsv(ATC_DATA_URL), fetchCsv(NOTICE_DATA_URL)])
                    .then(([drugData, atcData, noticeData]) => {
                        const atcMap = {};
                        atcData.forEach(row => {
                            if(row['藥品代碼']) {
                                atcMap[row['藥品代碼'].trim()] = {
                                    orderNote: row['醫令提示訊息'] ? row['醫令提示訊息'].trim() : '' 
                                };
                            }
                        });

                        processData(drugData, atcMap);

                        const allDrugsMap = {};
                        drugData.forEach(row => {
                            const drug = parseRowToDrug(row, atcMap);
                            if (drug) allDrugsMap[drug.code] = drug;
                        });

                        processNoticeData(noticeData, allDrugsMap);
                        loading.value = false;
                    })
                    .catch(err => {
                        console.error(err);
                        error.value = "資料讀取失敗，請稍後再試。";
                        loading.value = false;
                    });
            };

            const processData = (rawData, atcMap) => {
                let processed = rawData.map(row => {
                    const code = row['藥品代碼'] ? row['藥品代碼'].trim() : '';
                    if(!code) return null;
                    if (code.length !== 6) return null;
                    if (code.startsWith('653')) return null;

                    const genericName = row['學名'] || '';
                    const tradeName = row['商品名(英文)'] || row['商品名'] || '無商品名';

                    if (tradeName.includes('贈') || genericName.includes('贈')) return null;
                    if (tradeName.includes('(非本院品項)')) return null;
                    if (tradeName.includes('免費')) return null;

                    const status1 = row['門診停用否'] ? row['門診停用否'].trim().toUpperCase() : '';
                    const status2 = row['住院停用否'] ? row['住院停用否'].trim().toUpperCase() : '';
                    let isDiscontinued = (status1 === 'Y' || status2 === 'Y') && !(status1 === 'N' || status2 === 'N');

                    if (isDiscontinued) return null;

                    const mapData = atcMap[code] || { orderNote: '' };
                    const imgName = row['圖檔名稱'] ? row['圖檔名稱'].trim() : '';
                    if (!imgName) return null;

                    return {
                        code, 
                        genericName, tradeName, 
                        indication: row['適應症']||row['臨床用途']||'尚無資料', 
                        sideEffect: row['副作用']||'',
                        profNote: row['注意事項'] ? row['注意事項'].trim() : '', 
                        appearance: row['藥品外觀'] ? row['藥品外觀'].trim() : '',
                        imgUrl: `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/image/upload/w_400,c_scale,q_auto,f_auto/${imgName}`,
                    };
                }).filter(d => d !== null);

                drugs.value = processed;
                fuse = new Fuse(processed, fuseOptions);
            };

            const processNoticeData = (data, allDrugsMap) => {
                if (!data || data.length === 0) return;

                const now = new Date();
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(now.getMonth() - 6);

                let processed = data.map(row => {
                    const dateStr = row['異動日期'] ? row['異動日期'].trim() : '';
                    if (!dateStr) return null;

                    const dateParts = dateStr.split('/');
                    if (dateParts.length < 3) return null;
                    
                    const noticeDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));

                    if (noticeDate < sixMonthsAgo) return null;

                    const beforeCode = row['異動前'] ? row['異動前'].trim() : '';
                    const afterCode = row['異動後'] ? row['異動後'].trim() : '';

                    const beforeDrug = allDrugsMap[beforeCode] || null;
                    const afterDrug = allDrugsMap[afterCode] || null;

                    if (!beforeDrug && !afterDrug) return null;

                    const displayDrug = afterDrug || beforeDrug;

                    return {
                        date: dateStr,
                        sortingKey: parseDateToNumber(dateStr),
                        nameBefore: beforeDrug ? beforeDrug.tradeName : '查無資料',
                        nameAfter: afterDrug ? afterDrug.tradeName : '查無資料',
                        imgBefore: beforeDrug ? beforeDrug.imgUrl : null,
                        imgAfter: afterDrug ? afterDrug.imgUrl : null,
                        content: displayDrug.genericName,
                        indication: displayDrug.indication
                    };
                }).filter(d => d !== null);

                processed.sort((a, b) => b.sortingKey - a.sortingKey);
                notices.value = processed;
            };

            const parseDateToNumber = (dateStr) => {
                const parts = dateStr.split('/'); 
                if (parts.length < 3) return 0;
                const y = parts[0];
                const m = parts[1].padStart(2, '0'); 
                const d = parts[2].padStart(2, '0'); 
                return parseInt(y + m + d);
            };

            const filteredDrugs = computed(() => {
                if (!keyword.value) return [];
                const k = keyword.value.trim();
                if (fuse) {
                    const searchResults = fuse.search(k);
                    return searchResults.map(res => res.item);
                }
                return [];
            });

            const resetToHome = () => { keyword.value = ''; };
            const openDetail = (drug) => selectedDrug.value = drug;
            const closeDetail = () => selectedDrug.value = null;
            const imageLoadError = (e) => { e.target.style.display = 'none'; }; 

            onMounted(() => { fetchAllData(); });

            return {
                keyword, filteredDrugs, selectedDrug, loading, error, notices,
                resetToHome, openDetail, closeDetail, imageLoadError
            };
        }
    }).mount('#app');
</script>
</body>
</html>
